<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>X√°c nh·∫≠n thanh to√°n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            text-align: center;
        }

        .qr-box {
            margin-top: 20px;
        }

        .info {
            margin: 20px auto;
            width: 300px;
            text-align: left;
        }

        .info p {
            margin: 4px 0;
        }

        .items {
            margin-top: 20px;
            text-align: left;
            display: inline-block;
        }

        .items ul {
            padding-left: 20px;
        }
    </style>
</head>

<body>
    <h1>üßæ Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</h1>
    <div class="qr-box">
        <img src="/static/qr_{{ order_id }}.png" alt="QR Code" style="width: 400px;">
    </div>
    <div class="info">
        <p><strong>T·ªïng ti·ªÅn:</strong> {{ total }} VNƒê</p>
        <p><strong>Ph∆∞∆°ng th·ª©c:</strong> {{ payment_method }}</p>
        <p>{{ booking_id }}</p>
        <p>{{ order_id }}"</p>
    </div>
    <div class="items">
        <h3>Chi ti·∫øt m√≥n:</h3>
        <ul>
            {% for item in items %}
            <li>{{ item.nameFood }} x {{ item.quantity }} ({{ item.price }} VNƒê)</li>
            <li>{{item.idFood}}</li>
            <li>{{booking_id}}</li>
            {% endfor %}
        </ul>
    </div>
    <script>
        const orderId = "{{ order_id }}";
        const items = JSON.parse('{{ items | tojson | safe }}');
        const total = '{{ total }}';
        const bookingId = JSON.parse('{{ booking_id | tojson }}'); // üëà quan tr·ªçng!
        setInterval(() => {
            fetch(`/check_payment_status/${orderId}`)
                .then(res => res.text())
                .then(status => {
                    if (status === "paid") {
                        // ‚úÖ G·ªçi API l∆∞u v√†o DB
                        fetch('/save_order_items_counter', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    items: items,
                                    total: total,
                                    id_table: bookingId // Flask render: c√≥ th√¨ ra s·ªë, kh√¥ng th√¨ ra r·ªóng
                                })
                            })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    if (bookingId) {
                                        window.location.href = `/hoadon/${data.order_id}?type=booking`;
                                    } else {
                                        window.location.href = `/hoadon/${data.order_id}`;
                                    }
                                } else {
                                    alert("L∆∞u ƒë∆°n th·∫•t b·∫°i: " + data.message);
                                }
                            })

                            .catch(err => {
                                console.error('L·ªói l∆∞u ƒë∆°n:', err);
                            });

                    }
                });
        }, 3000);
    </script>


</body>

</html>