<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>QR Thanh toÃ¡n</title>
</head>

<body>
  <h1>ğŸ§¾ QuÃ©t mÃ£ QR Ä‘á»ƒ thanh toÃ¡n báº±ng {{ payment_method.upper() }}</h1>

  <img src="/static/qr_{{ order_id }}.png" alt="QR Code" style="width: 200px;">
  <p><strong>TÃªn:</strong> {{ name }}</p>
  <p><strong>NgÃ¢n HÃ ng</strong> {{ payment_method }}</p>
  <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i (STK):</strong> {{ phone }}</p>
  <p><strong>Sá»‘ tiá»n:</strong> {{ total }} VND</p>

  <p><a href="{{ url }}">ğŸ”— Hoáº·c báº¥m vÃ o Ä‘Ã¢y náº¿u khÃ´ng quÃ©t Ä‘Æ°á»£c</a></p>
  <h2>Danh sÃ¡ch mÃ³n Ä‘Ã£ chá»n:</h2>
  <ul>
    {% for item in items %}
    <li>{{ item.name }} - SL: {{ item.qty }}</li>
    <li>{{ item.idFood}} ,
      {{item.qty}} ,
      {{item.unitPrice}} </li>
    {% endfor %}
  </ul>
  <p><strong>MÃ£ giáº£m giÃ¡:</strong> {{ discount_code if discount_code else "KhÃ´ng cÃ³" }}</p>
  <a href="/fake_payment/{{ order_id }}?total={{ total }}&name={{ name }}&phone={{ phone }}" target="_blank">qqqqqqqqqqqqqqqqqqqqqqqq</a>

  <script>
    const orderId = "{{ order_id }}";
    const items = JSON.parse('{{ items|tojson | safe }}');

    setInterval(() => {
      fetch(`/check_payment_status/${orderId}`)
        .then(res => res.text())
        .then(status => {
          console.log("STATUS:", status); // Ä‘á»ƒ xem log
          if (status === "paid") {
            // Gá»i API lÆ°u Ä‘Æ¡n hÃ ng trÆ°á»›c
            fetch('/save_order_items', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                credentials: 'include', // thÃªm dÃ²ng nÃ y Ä‘á»ƒ gá»­i cookie/session
                body: JSON.stringify({
                  order_id: orderId,
                  items: items,
                  total: '{{ total }}', // hoáº·c '{{ total }}' náº¿u báº¡n muá»‘n cháº¯c cháº¯n kiá»ƒu chuá»—i
                  discount_code: '{{ discount_code }}'  ,
                  phone :'{{phone}}'
                })
              })
              .then(res => res.json())
              .then(data => {
                if (data.success) {
                  // Náº¿u lÆ°u thÃ nh cÃ´ng thÃ¬ chuyá»ƒn trang
                  window.location.href = `/intro?order_id=${orderId}`;
                } else {
                  alert('LÆ°u Ä‘Æ¡n hÃ ng tháº¥t báº¡i!');
                }
              })
              .catch(err => {
                console.error('Lá»—i lÆ°u Ä‘Æ¡n hÃ ng:', err);
              });
          }
        });
    }, 3000);
  </script>



</body>

</html>