<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang qu·∫£n tr·ªã</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='CssTotal/warehouse_admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='CssTotal/sidebar_staff.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='CssTotal/navbar_admin.css') }}">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .low-stock {
            background-color: #ffdddd !important;
            color: red;
            font-weight: bold;
        }

        body {
            font-family: Arial, sans-serif;
        }

        h1 {
            color: #333;
        }

        h3 {
            margin-top: 20px;
            color: #333;
        }

        .table-wrapper {
            max-height: 454px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 12px 15px;
            border: 1px solid #ddd;
            text-align: left;
            border-top: 0px;
        }

        th {
            background: #4CAF50;
            color: white;
        }

        thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            height: 50px;
        }

        tr:nth-child(even) {
            background: #f2f2f2;
        }

        .action-buttons {
            margin-bottom: 20px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            margin-right: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #45a049;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        input[type="number"] {
            padding: 5px;
        }

        .date {
            width: 200px;

        }

        .table-wrapper {
            max-height: 400px;
            /* üëà Chi·ªÅu cao t·ªëi ƒëa */
            overflow-y: auto;
            /* üëà Thanh cu·ªôn d·ªçc khi c·∫ßn */
            border: 1px solid #ccc;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
    </style>
    <style>
        .low-stock {
            background-color: #ffe6e6;
            color: red;
            font-weight: bold;
        }
    </style>

    <script>
        function togglePanel(panelId) {
            document.querySelectorAll('.panel').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(panelId).classList.add('active');
        }

        function submitImport() {
    const formData = [];
    document.querySelectorAll("#importForm tbody tr").forEach(row => {
        const id = row.querySelector('input[name="id_ingredient_hidden"]').value.trim();
        const quantityInput = row.querySelector(`input[name="quantity_${id}"]`);
        const unitPriceInput = row.querySelector(`input[name="unit_price_${id}"]`);

        const quantity = parseInt(quantityInput.value) || 0;
        const unit_price = parseInt(unitPriceInput.value) || 0;

        if (quantity > 0 && unit_price > 0) {
            formData.push({
                IdIngredient: id,
                quantity: quantity,
                unit_price: unit_price
            });
        }
    });

    if (formData.length === 0) {
        alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng v√† ƒë∆°n gi√° > 0 cho √≠t nh·∫•t 1 nguy√™n li·ªáu.");
        return;
    }

    fetch("/import_staff_post", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                items: formData
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                alert(data.message);
                window.location.reload();
            } else {
                alert("C√≥ l·ªói: " + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert("L·ªói khi nh·∫≠p kho!");
        });
}

    </script>
</head>

<body>

    {% include "partials/sidebar_staff.html" %}

    <div class="main" id="main">
        {% include "partials/navbar_staff.html" %}
        <div class="inner-position">
            <h2>X·ª≠ l√Ω phi·∫øu nh·∫≠p xu·∫•t</h2>
            <div class="position-right">
                <a href="intro.html">Trang ch·ªß /</a>
                <p>Phi·∫øu nh·∫≠p/xu·∫•t</p>
            </div>
        </div>

        <h1>Qu·∫£n l√Ω Nguy√™n li·ªáu</h1>
        <form id="filterForm" style="display:inline;">
            T·ª´:
            <input type="date" name="from" style="width: 200px;" id="from_date" value="{{ from_date }}">
            ƒê·∫øn:
            <input type="date" name="to" style="width: 200px;" id="to_date" value="{{ to_date }}">
            <button type="button" class="btn" onclick="applyFilter()">L·ªçc</button>
        </form>
        <div class="action-buttons">

            <button class="btn" onclick="togglePanel('panel-used')">Nguy√™n li·ªáu ƒë√£ ti√™u</button>
            <button class="btn" onclick="togglePanel('panel-remaining')">Nguy√™n li·ªáu c√≤n l·∫°i</button>
            <button class="btn" onclick="togglePanel('panel-import')">Nh·∫≠p kho</button>
            <button class="btn" onclick="togglePanel('panel-export')">Xu·∫•t kho</button>
            <button class="btn" onclick="togglePanel('panel-adjust')">ƒêi·ªÅu ch·ªânh cu·ªëi ng√†y</button>
        </div>

        <!-- Panel Xu·∫•t kho -->
        <div id="panel-export" class="panel">
            <h3>Xu·∫•t kho nguy√™n li·ªáu</h3>
            <div class="table-wrapper">
                <form id="exportForm">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n nguy√™n li·ªáu</th>
                                <th>S·ªë l∆∞·ª£ng c√≤n</th>
                                <th>S·ªë l∆∞·ª£ng xu·∫•t</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ing in remaining_ingredients %}
                            <tr>
                                <td>
                                    {{ ing.IdIngredient }}
                                    <input type="hidden" name="id_ingredient_hidden" value="{{ ing.IdIngredient }}">
                                </td>
                                <td>{{ ing.nameIngredient }}</td>
                                <td>{{ ing.remaining_quantity }}</td>
                                <td><input type="number" name="export_{{ ing.IdIngredient }}" min="0" value="0"
                                        style="width:80px;"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" class="btn" onclick="submitExport()">X√°c nh·∫≠n Xu·∫•t Kho</button>
                </form>
            </div>
        </div>


        <!-- B·∫£ng ƒë√£ ti√™u -->
        <div id="panel-used" class="panel">
            <h3>Nguy√™n li·ªáu ƒë√£ ti√™u</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n nguy√™n li·ªáu</th>
                            <th>S·ªë l∆∞·ª£ng ƒë√£ ti√™u</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in used_ingredients %}
                        <tr>
                            <td>{{ u.IdIngredient }}</td>
                            <td>{{ u.nameIngredient }}</td>
                            <td>{{ u.used_quantity }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- B·∫£ng c√≤n l·∫°i -->
        <div id="panel-remaining" class="panel">
            <h3>Nguy√™n li·ªáu c√≤n l·∫°i trong kho</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n nguy√™n li·ªáu</th>
                            <th>S·ªë l∆∞·ª£ng c√≤n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in remaining_ingredients %}
                        <tr>
                            <td>{{ r.IdIngredient }}</td>
                            <td>{{ r.nameIngredient }}</td>
                            {% set is_low = r.remaining_quantity < 50 %}
                            <td class="{{ 'low-stock' if is_low else '' }}">{{ r.remaining_quantity }}</td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>

        <!-- Panel nh·∫≠p kho -->
        <div id="panel-import" class="panel">
            <h3>Nh·∫≠p kho nguy√™n li·ªáu</h3>
            <div class="table-wrapper">
                <form id="importForm">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n nguy√™n li·ªáu</th>
                                <th>S·ªë l∆∞·ª£ng c√≤n</th>
                                <th>S·ªë l∆∞·ª£ng nh·∫≠p</th>
                                <th>ƒê∆°n gi√°</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ing in remaining_ingredients %}
                            <tr>
                                <td>
                                    {{ ing.IdIngredient }}
                                    <input type="hidden" name="id_ingredient_hidden" value="{{ ing.IdIngredient }}">
                                </td>
                                <td>{{ ing.nameIngredient }}</td>
                                <td>{{ ing.remaining_quantity }}</td>
                                <td><input type="number" name="quantity_{{ ing.IdIngredient }}" min="0" value="0"
                                        style="width:80px;"></td>
                                <td><input type="number" name="unit_price_{{ ing.IdIngredient }}" min="0" value="0"
                                        style="width:100px;"></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" class="btn" onclick="submitImport()">X√°c nh·∫≠n Nh·∫≠p Kho</button>
                </form>
            </div>
        </div>


        <!-- Panel ƒëi·ªÅu ch·ªânh cu·ªëi ng√†y -->

        <!-- Panel ƒëi·ªÅu ch·ªânh cu·ªëi ng√†y -->
        <div id="panel-adjust" class="panel">
            <h3>ƒêi·ªÅu ch·ªânh t·ªìn kho cu·ªëi ng√†y</h3>
            <div class="table-wrapper">
                <form id="adjustForm">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>T√™n nguy√™n li·ªáu</th>
                                <th>ƒê√£ xu·∫•t</th>
                                <th>Th·ª±c t·∫ø d√πng</th>
                                <th>Ch√™nh l·ªách</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for adj in used_ingredients %}
                            {% set exported = (exported_ingredients | selectattr('IdIngredient', 'equalto', adj.IdIngredient) | list) %}
                            {% if exported %}
                            {% set exp_qty = exported[0].exported_quantity %}
                            {% else %}
                            {% set exp_qty = 0 %}
                            {% endif %}
                            <tr>
                                <td>
                                    {{ adj.IdIngredient }}
                                    <input type="hidden" name="id_ingredient_hidden" value="{{ adj.IdIngredient }}">
                                </td>
                                <td>{{ adj.nameIngredient }}</td>
                                <td class="exported">{{ exp_qty }}</td>
                                <td>
                                    <input type="number" name="real_{{ adj.IdIngredient }}" min="0"
                                        value="{{ adj.used_quantity }}" onchange="calcDiff(this)" style="width:80px;">
                                </td>
                                <td class="diff">{{ exp_qty - adj.used_quantity }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" class="btn" onclick="submitAdjust()">X√°c nh·∫≠n ƒêi·ªÅu ch·ªânh</button>
                </form>
            </div>
        </div>



        <script>
            function calcDiff(input) {
                const row = input.closest('tr');
                const exported = parseInt(row.querySelector('.exported').innerText) || 0;
                const realUsed = parseInt(input.value) || 0;
                const diff = exported - realUsed; // ‚úÖ Xu·∫•t - Th·ª±c t·∫ø d√πng
                row.querySelector('.diff').innerText = diff;
            }


            function submitAdjust() {
                const formData = [];
                document.querySelectorAll("#adjustForm tbody tr").forEach(row => {
                    const id = row.querySelector('input[name="id_ingredient_hidden"]').value.trim();

                    const exported = parseInt(row.querySelector('.exported').innerText) || 0;
                    const realUsedInput = row.querySelector(`input[name="real_${id}"]`);
                    const realUsed = parseInt(realUsedInput.value) || 0;
                    const diff = exported - realUsed;

                    if (diff !== 0) {
                        formData.push({
                            IdIngredient: id,
                            diff: diff
                        });
                    }
                });

                if (formData.length === 0) {
                    alert("Kh√¥ng c√≥ ch√™nh l·ªách n√†o c·∫ßn ƒëi·ªÅu ch·ªânh.");
                    return;
                }

                fetch("/adjust_stock_post", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            adjustments: formData
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert("C√≥ l·ªói: " + data.message);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("L·ªói khi ƒëi·ªÅu ch·ªânh kho!");
                    });
            }

            function submitExport() {
                const formData = [];
                let hasError = false;

                document.querySelectorAll("#exportForm tbody tr").forEach(row => {
                    const id = row.querySelector('input[name="id_ingredient_hidden"]').value.trim();
                    const quantityInput = row.querySelector('input[type="number"]');
                    const quantity = parseInt(quantityInput.value) || 0;

                    const remainingCell = row.querySelector("td:nth-child(3)");
                    const remaining = parseInt(remainingCell.innerText) || 0;

                    if (quantity > 0) {
                        if (quantity > remaining) {
                            alert(
                                `‚ùå S·ªë l∆∞·ª£ng xu·∫•t (${quantity}) v∆∞·ª£t qu√° t·ªìn kho (${remaining}) c·ªßa nguy√™n li·ªáu ID ${id}!`);
                            hasError = true;
                            return;
                        }

                        formData.push({
                            IdIngredient: id,
                            quantity: quantity
                        });
                    }
                });

                if (hasError) return;

                if (formData.length === 0) {
                    alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 nguy√™n li·ªáu ƒë·ªÉ xu·∫•t kho.");
                    return;
                }

                fetch("/export_staff_post", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            items: formData
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            alert(data.message);
                            window.location.reload();
                        } else {
                            alert("C√≥ l·ªói: " + data.message);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("L·ªói khi xu·∫•t kho!");
                    });
            }

            function applyFilter() {
                const from = document.getElementById("from_date").value;
                const to = document.getElementById("to_date").value;

                if (!from || !to) {
                    alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß t·ª´ ng√†y - ƒë·∫øn ng√†y!");
                    return;
                }

                // G·ª≠i l·∫°i trang c√≥ tham s·ªë
                window.location.href = `/import_staff?from=${from}&to=${to}`;
            }
        </script>

</body>

</html>